<!doctype html>
<html lang='en'>

<head>
    <meta charset='UTF-8'>
    <meta name='viewport'
          content='width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0'>
    <meta http-equiv='X-UA-Compatible' content='ie=edge'>
    <title>D3绘制折线</title>
    <script src='d3/d3.min.js'></script>
    <script>
        //绘制折线图
        window.onload = function () {
        let SVG_SIZE = { width: 800, height: 600 }
        let SVG_MARGIN = { left: 60, top: 60, right: 60, bottom: 60 }
        let data = {
        'haxis': XXXXXX,
        //'long5': { 'color': '#800000', 'list': LLL5LLL },
        //'short5': { 'color': '#008000', 'list': SSS5SSS },
        //'long10': { 'color': '#000080', 'list': LLL10LLL },
        //'short10': { 'color': '#800080', 'list': SSS10SSS },
        //'long20': { 'color': '#808000', 'list': LLL20LLL },
        //'short20': { 'color': '#008080', 'list': SSS20SSS },
        'long5short': { 'color': '#FF0080', 'list': LLL5SSS },
        'long10short': { 'color': '#00FF80', 'list': LLL10SSS },
        'long20short': { 'color': '#0080FF', 'list': LLL20SSS }
        };
        function draw_line(svg_g, dot, data_list, line_generator, line_color, tips_text) {
        svg_g.append('path')
        .attr('d', line_generator)
        .attr('fill', 'none')
        .attr('stroke', line_color)
        .attr('stroke-linejoin', 'round')
        .attr('stroke-linecap', 'round')
        .attr('stroke-width', '2')
        .attr('cursor', 'pointer')
        .on('touchmove', function (d, i) {
        d3.select(this).transition().duration(100).attr('stroke', '#CB7730');
        })
        .on('touchstart', function (d, i) {
        d3.select(this).transition().duration(100).attr('stroke', '#CB7730');
        })
        .on('touchend', function (d, i) {
        d3.select(this).transition().duration(100).attr('stroke', line_color);
        })
        .on('mousemove', function (d, i) {
        d3.select(this).transition().duration(100).attr('stroke', '#CB7730');
        d3.event.preventDefault();
        dot.attr('display', null);
        console.log(d3.event.layerX + '--' + d3.event.layerY);
        if (d3.event.layerX <= SVG_SIZE.width && d3.event.layerX >= 0) {
        let offset = (d3.event.layerX - SVG_MARGIN.left) / ((SVG_SIZE.width - SVG_MARGIN.right - SVG_MARGIN.left) / data.haxis.length);
        let index = parseInt(offset.toString());
        console.log(offset + ']------' + index + ']------' + data.haxis[index] + ',' + data_list[index]);
        dot.attr('transform', 'translate(' + d3.event.layerX + ',' + d3.event.layerY + ')');
        dot.select('text').text(tips_text + '|' + data.haxis[index] + '|' + data_list[index]);
        }
        })
        .on('mouseover', function (d, i) {
        d3.select(this).transition().duration(100).attr('stroke', '#CB7730');
        })
        .on('mouseout', function (d, i) {
        d3.select(this).transition().duration(100).attr('stroke', line_color);
        dot.attr('display', 'none');
        })
        .on('click', function () {
        alert('曲线事件已触发！');
        });
        }
        function domain_min_max(data, except) {
        let min = null;
        let max = null;
        for (let key in data) {
        if (key != except) {
        if (min == null) {
        min = (d3.min(data[key]['list'], function (d) { return parseFloat(d); }));
        }
        else {
        min = d3.min([min, (d3.min(data[key]['list'], function (d) { return parseFloat(d); }))]);
        }
        if (max == null) {
        max = (d3.max(data[key]['list'], function (d) { return parseFloat(d); }));
        }
        else {
        max = d3.max([max, (d3.max(data[key]['list'], function (d) { return parseFloat(d); }))]);
        }
        }
        }
        return [min, max];
        }
        function poly_line(data) {
        let svg_g = d3.select('#container-line').append('svg').attr('width', SVG_SIZE.width).attr('height', SVG_SIZE.height).append('g');
        //let xranges = d3.range(data.haxis.length);
        //var parseTime = d3.timeParse('%Y%m%d');
        //var formatTime = d3.timeParse('%Y%m%d');
        let xScale = d3.scaleBand()
        //.domain([parseTime(data.haxis[0]),parseTime(data.haxis[data.haxis.length - 1])])
        /*.domain(d3.extent(data.haxis, function(d) {
        let date = d.substr(0,4) + '-' + d.substr(4,2) + '-' + d.substr(6,2) + ' 00:00:00'
        console.log(Date.parse(new Date(date)).toString());
        return Date.parse(new Date(date))/1000; return parseInt(d);}))*/
        //.domain(d3.extent(data.haxis, function(d) {return d;}))
        .domain(data.haxis)
        .rangeRound([SVG_MARGIN.left, SVG_SIZE.width - SVG_MARGIN.right]);
        let xAxis = d3.axisBottom(xScale);
        let yScale = d3.scaleLinear()
        .domain(domain_min_max(data, 'haxis'))
        .rangeRound([SVG_SIZE.height - SVG_MARGIN.top, SVG_MARGIN.bottom]);
        let yAxis = d3.axisLeft(yScale);

        svg_g
        .append('g')
        .attr('transform', 'translate(0,' + (SVG_SIZE.height - SVG_MARGIN.bottom) + ')')
        .call(xAxis)
        .selectAll('text')
        .attr('transform', 'translate(-' + ((SVG_SIZE.width - SVG_MARGIN.left - SVG_MARGIN.right) / data.haxis.length / 2) + ',0)rotate(-45)')
        .style('text-anchor', 'end');
        svg_g.append('g')
        .attr('transform', 'translate(' + SVG_MARGIN.left + ',0)')
        .call(yAxis)
        .selectAll('text');

        svg_g.append('text')
        .attr('transform', 'translate(' + SVG_MARGIN.left + ',' + SVG_MARGIN.bottom + ')')
        .attr('x', 3)
        .attr('text-anchor', 'start')
        .attr('font-weight', 'bold')
        .text('手数/天');

        let line_generator = d3.line()
        .x(function (d, i) {
        console.log('x->' + data.haxis[i] + ',type=' + typeof (data.haxis[i]));
        return xScale(data.haxis[i]);
        })
        .y(function (d, i) {
        console.log('y->' + d);
        return yScale(d);
        })
        //折线变得圆滑，如果不需要可以去掉
        ;//.curve(d3.curveMonotoneX);
        let dot = svg_g.append('g')
        .attr('display', 'none');
        dot.append('circle')
        .attr('r', 2.5);
        dot.append('text')
        .style('font', '10px sans-serif')
        .attr('text-anchor', 'middle')
        .attr('y', -8);
        for (let key in data) {
        if (key != 'haxis') {
        draw_line(svg_g, dot, data[key]['list'], line_generator(data[key]['list']), data[key]['color'], '[' + key + ']');
        }
        }
        }
        // 绘制多条折线图
        poly_line(data);
        }
    </script>
</head>

<body>
    <div id='container-line' width='800' height='600'></div>
</body>

</html>