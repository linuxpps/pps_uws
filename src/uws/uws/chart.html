<!doctype html>
<html lang='en'>

<head>
    <meta charset='UTF-8'>
    <meta name='viewport'
          content='width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0'>
    <meta http-equiv='X-UA-Compatible' content='ie=edge'>
    <title>D3绘制折线</title>
    <style>
        .focusLine {
            fill: none;
            stroke: steelblue;
            stroke-width: 0.5px;
        }

        .focusCircle {
            fill: red;
        }
    </style>
    <script src='d3/d3.min.js'></script>
    <script>
        //绘制折线图
        window.onload = function () {
            let SVG_SIZE = { width: 800, height: 600 }
            let SVG_MARGIN = { left: 60, top: 60, right: 60, bottom: 60 }
            let data = {
                'haxis': XXXXXX,
                //'long5': { 'color': '#800000', 'list': LLL5LLL },
                //'short5': { 'color': '#008000', 'list': SSS5SSS },
                //'long10': { 'color': '#000080', 'list': LLL10LLL },
                //'short10': { 'color': '#800080', 'list': SSS10SSS },
                //'long20': { 'color': '#808000', 'list': LLL20LLL },
                //'short20': { 'color': '#008080', 'list': SSS20SSS },
                'long5short': { 'color': '#FF0080', 'list': LLL5SSS },
                'long10short': { 'color': '#00FF80', 'list': LLL10SSS },
                'long20short': { 'color': '#0080FF', 'list': LLL20SSS }
            };

            function domain_min_max(data, except) {
                let min = null;
                let max = null;
                for (let key in data) {
                    if (key != except) {
                        if (min == null) {
                            min = (d3.min(data[key]['list'], function (d) { return parseFloat(d); }));
                        }
                        else {
                            min = d3.min([min, (d3.min(data[key]['list'], function (d) { return parseFloat(d); }))]);
                        }
                        if (max == null) {
                            max = (d3.max(data[key]['list'], function (d) { return parseFloat(d); }));
                        }
                        else {
                            max = d3.max([max, (d3.max(data[key]['list'], function (d) { return parseFloat(d); }))]);
                        }
                    }
                }
                return [min, max];
            }
            function poly_line(data) {
                let svg_g = d3.select('#container-line').append('svg').attr('width', SVG_SIZE.width).attr('height', SVG_SIZE.height).append('g');
                //let xranges = d3.range(data.haxis.length);
                //var parseTime = d3.timeParse('%Y%m%d');
                //var formatTime = d3.timeParse('%Y%m%d');
                let xScale = d3.scaleBand().paddingInner(1).paddingOuter(1)//.step((SVG_SIZE.width - SVG_MARGIN.left - SVG_MARGIN.right) / data.haxis.length)
                    //.domain([parseTime(data.haxis[0]),parseTime(data.haxis[data.haxis.length - 1])])
                    //.domain(d3.extent(data.haxis, function(d) {
                    //    let date = d.substr(0, 4) + '-' + d.substr(4, 2) + '-' + d.substr(6, 2);// + ' 00:00:00'
                    //console.log(Date.parse(new Date(date)).toString());
                    //    return new Date(date);return Date.parse(new Date(date))/1000; return parseInt(d);}))
                    //.domain(d3.extent(data.haxis, function(d) {return d;}))
                    .domain(data.haxis)
                    .rangeRound([SVG_MARGIN.left, SVG_SIZE.width - SVG_MARGIN.right]);
                let xAxis = d3.axisBottom(xScale);
                let yScale = d3.scaleLinear()
                    .domain(domain_min_max(data, 'haxis'))
                    .rangeRound([SVG_SIZE.height - SVG_MARGIN.top, SVG_MARGIN.bottom]);
                let yAxis = d3.axisLeft(yScale);

                svg_g
                    .append('g')
                    .attr('transform', 'translate(0,' + (SVG_SIZE.height - SVG_MARGIN.bottom) + ')')
                    .call(xAxis)
                    .selectAll('text')
                    .attr('transform', 'rotate(-45)')
                    //.attr('transform', 'translate(-' + ((SVG_SIZE.width - SVG_MARGIN.left - SVG_MARGIN.right) / data.haxis.length / 2) + ',0)rotate(-45)')
                    .style('text-anchor', 'end');
                svg_g.append('g')
                    .attr('transform', 'translate(' + SVG_MARGIN.left + ',0)')
                    .call(yAxis)
                    .selectAll('text');

                svg_g.append('text')
                    .attr('transform', 'translate(' + SVG_MARGIN.left + ',' + SVG_MARGIN.bottom + ')')
                    //.attr('x', 3)
                    .attr('text-anchor', 'start')
                    //.attr('font-weight', 'bold')
                    .text('手数/天');

                let line_generator = d3.line()
                    .x(function (d, i) {
                        console.log('x->' + data.haxis[i] + ',type=' + typeof (data.haxis[i]) + ',xScale(data.haxis[i])=' + xScale(data.haxis[i]));
                        return xScale(data.haxis[i]);
                    })
                    .y(function (d, i) {
                        console.log('y->' + d + ',yScale(d)=' + yScale(d));
                        return yScale(d);
                    })
                    //折线变得圆滑，如果不需要可以去掉
                    ;//.curve(d3.curveMonotoneX);
                let dots;
                //for (let key in data) {
                //    if (key != 'haxis') {
                dots = svg_g.append('g')
                    .attr('display', 'none');
                dots.append('circle')
                    .attr('r', 4)
                    .attr("cx", function (d, i) { return xScale(data.haxis[i - 1]); })
                    .attr("cy", function (d, i) { return yScale(d); })
                    .style("fill", "#69A3A2");
                dots.append('text')
                    .style('font', '10px sans-serif')
                    .attr('text-anchor', 'middle')
                    .attr('y', -16);
                //    }
                //}
                for (let key in data) {
                    if (key != 'haxis') {
                        svg_g.append('path')
                            .attr('d', line_generator(data[key]['list']))
                            .attr('fill', 'none')
                            .attr('stroke', data[key]['color'])
                            .attr('stroke-linejoin', 'round')
                            .attr('stroke-linecap', 'round')
                            .attr('stroke-width', '2')
                            .attr('cursor', 'pointer')
                            .on('touchmove', function (d, i) {
                                d3.select(this).transition().duration(100).attr('stroke', '#CB7730');
                            })
                            .on('touchstart', function (d, i) {
                                d3.select(this).transition().duration(100).attr('stroke', '#CB7730');
                            })
                            .on('touchend', function (d, i) {
                                d3.select(this).transition().duration(100).attr('stroke', data[key]['color']);
                            })
                            .on('mousemove', function (d, i) {
                                d3.select(this).transition().duration(100).attr('stroke', '#CB7730');
                                d3.event.preventDefault();
                                dots.attr('display', null);
                                if (d3.event.layerX <= SVG_SIZE.width && d3.event.layerX >= 0) {
                                    console.log('(' + d3.event.layerX + ',' + d3.event.layerY + ')');
                                    console.log('step=' + xScale.step() + ',bandWidth=' + xScale.bandwidth() + ',padding=' + xScale.padding() + ',paddingIn=' + xScale.paddingInner() + ',paddingOut=' + xScale.paddingOuter());
                                    //let offset = (d3.event.layerX - SVG_MARGIN.left - xScale.step() - xScale.padding() - xScale.paddingOuter() - xScale.paddingInner()) / xScale.step();//(d3.event.layerX - SVG_MARGIN.left) / ((SVG_SIZE.width - SVG_MARGIN.right - SVG_MARGIN.left) / (data.haxis.length + 1));
                                    let offset = (d3.event.layerX - xScale.padding() - SVG_MARGIN.left - ((SVG_SIZE.width - SVG_MARGIN.left - SVG_MARGIN.right - xScale.step() * (data.haxis.length - 1)) / 2)) / xScale.step();//(d3.event.layerX - SVG_MARGIN.left) / ((SVG_SIZE.width - SVG_MARGIN.right - SVG_MARGIN.left) / (data.haxis.length + 1));
                                    let index = parseInt(offset.toString());
                                    if (index >= 0 && index < data.haxis.length) {
                                        console.log('(' + d3.event.layerX + ',' + d3.event.layerY + '),' +
                                            index + ',(' + xScale(data.haxis[index]) + ',' + yScale(data[key]['list'][index]) + '),(' + data.haxis[index] + ',' + data[key]['list'][index] + ')');
                                        dots.attr('transform', 'translate(' + xScale(data.haxis[index]) + ',' + yScale(data[key]['list'][index]) + ')');
                                        dots.select('text').text('[' + key + ']' + '|' + data.haxis[index] + '|' + data[key]['list'][index]);
                                    }
                                }
                            })
                            .on('mouseover', function (d, i) {
                                d3.select(this).transition().duration(100).attr('stroke', '#CB7730');
                                dots.attr('display', null);
                            })
                            .on('mouseout', function (d, i) {
                                d3.select(this).transition().duration(100).attr('stroke', data[key]['color']);
                                dots.attr('display', 'none');
                            })
                            .on('click', function () {
                                alert('曲线事件已触发！');
                            });
                    }
                }
            }
            // 绘制多条折线图
            poly_line(data);
        }
    </script>
</head>

<body>
    <div id='container-line' width='800' height='600'></div>
</body>

</html>